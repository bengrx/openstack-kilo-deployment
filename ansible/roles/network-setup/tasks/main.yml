---

 - name: Install the SSH authorized keys file
   copy: src=authorized_keys dest=~/.ssh/authorized_keys
   sudo: no

 - name: Install the SSH authorized keys file for root user
   copy: src=authorized_keys dest=~/.ssh/authorized_keys
   sudo: yes

 - name: Set the hostname for this node
   shell: hostname "{{ ansible_hostname }}"; echo "{{ ansible_hostname }}" >/etc/hostname
   sudo: yes

 - name: Generate the network configuration
   script: openstack-network-setup.sh
   environment: env
   sudo: yes

 - name: Prepare the new hosts file on the master controller
   shell: echo '# Generated by ansible\n\n127.0.0.1\tlocalhost\n\n# Hosts known to ansible\n' >/tmp/hosts
   run_once: yes
   delegate_to: "{{ openstack_ctl_master }}"

 - name: Generate a host entry for each nodes management interface
   shell: echo '{{ inventory_hostname }}\t{{ ansible_hostname }}'
   register: hostname_entry
   sudo: yes

 - name: Add the host entry to the master controller node
   shell: echo '{{ hostname_entry.stdout }}' >> /tmp/hosts
   delegate_to: "{{ openstack_ctl_master }}"
   sudo: yes

 - name: Get the dynamically generated hosts file and store it locally
   fetch: src=/tmp/hosts dest=/tmp/
   sudo: yes

 - name: Install the dynamically generated hosts file
   copy: src="/tmp/{{ openstack_ctl_master }}/tmp/hosts" dest=/etc/hosts
   sudo: yes

 - name: Restart the management controller device
   shell: ifdown {{ net_man_dev }} && ifup {{ net_man_dev }}
   sudo: yes

